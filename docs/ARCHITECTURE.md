# Архитектура приложения

## Обзор

"Капсульный Гардероб" - это веб-приложение для управления гардеробом, построенное на PHP с использованием архитектурного паттерна MVC (Model-View-Controller). Приложение использует PostgreSQL в качестве базы данных и развертывается через Docker.

## Технологический стек

- **Backend:** PHP 8.2
- **База данных:** PostgreSQL 15
- **Веб-сервер:** Nginx
- **Контейнеризация:** Docker & Docker Compose
- **Язык разметки:** HTML5, CSS3
- **JavaScript:** Vanilla JS (без фреймворков)

## Структура проекта

```
capsule-wardrobe-manager/
├── app/                          # Основной код приложения
│   ├── Controllers/              # Контроллеры (MVC)
│   │   ├── AnalyticsController.php
│   │   ├── AuthController.php
│   │   ├── CapsuleController.php
│   │   ├── Controller.php        # Базовый контроллер
│   │   ├── HomeController.php
│   │   ├── ItemController.php
│   │   ├── OutfitController.php
│   │   ├── TagController.php
│   │   └── TaxonomyController.php
│   ├── Core/                     # Ядро приложения
│   │   ├── Config.php            # Управление конфигурацией
│   │   ├── Database.php          # Подключение к БД
│   │   ├── Router.php            # Маршрутизация
│   │   └── Session.php           # Управление сессиями
│   ├── Middleware/               # Промежуточное ПО
│   │   └── AuthMiddleware.php    # Проверка аутентификации
│   ├── Models/                   # Модели данных (MVC)
│   │   ├── Analytics.php
│   │   ├── BaseModel.php         # Базовая модель
│   │   ├── Capsule.php
│   │   ├── Category.php
│   │   ├── Color.php
│   │   ├── Item.php
│   │   ├── Outfit.php
│   │   ├── Season.php
│   │   ├── Tag.php
│   │   └── User.php
│   ├── Services/                 # Бизнес-логика
│   │   └── TaxonomyService.php
│   └── Utils/                    # Утилиты
│       └── Logger.php            # Логирование
├── config/                       # Конфигурационные файлы
│   ├── app.php                   # Настройки приложения
│   ├── database.php              # Настройки БД
│   ├── paths.php                 # Пути к директориям
│   ├── routes.php                # Определение маршрутов
│   └── uploads.php               # Настройки загрузки файлов
├── docker/                       # Docker конфигурация
│   ├── nginx/
│   │   └── default.conf          # Конфигурация Nginx
│   ├── php/
│   │   ├── Dockerfile            # Образ PHP
│   │   └── php.ini               # Настройки PHP
│   └── postgres/
│       └── init.sql              # Инициализация БД
├── docs/                         # Документация
├── logs/                         # Логи приложения
├── public/                       # Публичная директория
│   ├── assets/                   # Статические ресурсы
│   │   ├── css/                  # Стили
│   │   └── js/                   # JavaScript
│   ├── js/                       # Клиентский JavaScript
│   ├── views/                    # Представления (MVC)
│   │   ├── analytics/
│   │   ├── auth/
│   │   ├── capsules/
│   │   ├── home/
│   │   ├── items/
│   │   ├── layouts/
│   │   ├── outfits/
│   │   ├── tags/
│   │   └── taxonomies/
│   └── index.php                 # Точка входа
├── composer.json                 # Зависимости PHP
├── docker-compose.yml            # Docker Compose конфигурация
└── README.md                     # Основная документация
```

## Архитектурные паттерны

### MVC (Model-View-Controller)

Приложение следует классическому паттерну MVC:

- **Model** (`app/Models/`) - Работа с данными, бизнес-логика
- **View** (`public/views/`) - Представление данных пользователю
- **Controller** (`app/Controllers/`) - Обработка запросов, координация между Model и View

### Базовые классы

#### Controller (app/Controllers/Controller.php)

Базовый класс для всех контроллеров, предоставляющий:
- Методы для работы с HTTP запросами
- Рендеринг представлений
- JSON ответы для API
- Редиректы
- Работу с сессиями и flash-сообщениями
- Валидацию AJAX запросов

#### BaseModel (app/Models/BaseModel.php)

Базовый класс для всех моделей, предоставляющий:
- CRUD операции
- Работу с базой данных через PDO
- Базовые методы поиска и фильтрации

## Поток выполнения запроса

```
1. Запрос → Nginx
2. Nginx → PHP-FPM (public/index.php)
3. index.php:
   - Загрузка автозагрузчика классов
   - Инициализация сессии
   - Загрузка конфигурации
   - Загрузка маршрутов
4. Router → Определение маршрута
5. Router → Вызов соответствующего контроллера
6. Controller:
   - Проверка аутентификации (если требуется)
   - Валидация входных данных
   - Вызов методов Model
   - Формирование ответа (HTML или JSON)
7. Ответ → Nginx → Клиент
```

## Компоненты системы

### 1. Роутинг (app/Core/Router.php)

Простой роутер на основе регулярных выражений:
- Поддержка GET, POST, PUT, PATCH, DELETE методов
- Параметры маршрутов (например, `/items/{id}`)
- Именованные маршруты
- Обработка 404 и 500 ошибок

**Пример маршрута:**
```php
$router->get('/items/{id}', 'ItemController@show', 'items.show');
```

### 2. База данных (app/Core/Database.php)

Singleton для подключения к PostgreSQL:
- Использует PDO
- Поддержка prepared statements
- Обработка ошибок
- Логирование запросов (в режиме отладки)

### 3. Сессии (app/Core/Session.php)

Обертка над PHP сессиями:
- Безопасное хранение данных пользователя
- Flash-сообщения (одноразовые сообщения)
- Управление временем жизни сессии

### 4. Аутентификация (app/Middleware/AuthMiddleware.php)

Промежуточное ПО для проверки аутентификации:
- Проверка наличия сессии пользователя
- Редирект на страницу входа (для веб-запросов)
- JSON ответ с ошибкой (для API запросов)

### 5. Логирование (app/Utils/Logger.php)

Система логирования:
- Уровни: DEBUG, INFO, WARNING, ERROR
- Запись в файл `logs/app.log`
- Контекстная информация (user_id, параметры запроса)

## Модели данных

### Item (Вещи)

Основная сущность - вещь в гардеробе:
- Хранение изображения в БД (BYTEA)
- Связи с категориями, цветами, сезонами
- Множественные теги
- Счетчик использования

### Outfit (Образы)

Комбинация вещей:
- Связь многие-ко-многим с вещами
- Позиционирование вещей
- Уровень формальности
- Избранное

### Capsule (Капсулы)

Группы вещей и образов:
- Связь с вещами и образами
- Генерация комбинаций
- Автоматическая генерация образов

### Tag (Теги)

Гибкая система тегирования:
- Системные теги (общие для всех)
- Пользовательские теги
- Связь с вещами и образами

## Безопасность

### Аутентификация

- Хеширование паролей через `password_hash()` (bcrypt)
- Проверка паролей через `password_verify()`
- Сессии с защитой от XSS (httponly cookies)

### Валидация данных

- Валидация всех входных данных на стороне сервера
- Проверка типов данных
- Санитизация HTML (htmlspecialchars)
- Проверка прав доступа (пользователь может изменять только свои данные)

### Защита от SQL-инъекций

- Использование prepared statements (PDO)
- Параметризованные запросы

### Загрузка файлов

- Проверка MIME-типа файла
- Ограничение размера файла (5MB)
- Валидация расширения файла
- Хранение в БД (избегание проблем с файловой системой)

## Производительность

### Индексы базы данных

- Индексы на часто используемых полях (user_id, category_id, color_id)
- Индексы для поиска (email, name)
- Индексы для сортировки (created_at, usage_count)

### Кеширование

- Кеширование изображений через HTTP заголовки (Cache-Control)
- Возможность добавления кеширования справочников (в будущем)

### Оптимизация запросов

- Использование JOIN вместо множественных запросов
- Представления (views) для сложных запросов
- Триггеры для автоматического обновления счетчиков

## Масштабируемость

### Горизонтальное масштабирование

- Stateless приложение (данные в сессиях)
- Возможность использования Redis для сессий
- База данных может быть вынесена на отдельный сервер

### Вертикальное масштабирование

- Docker позволяет легко увеличить ресурсы контейнеров
- Настройка PHP-FPM пулов
- Оптимизация запросов к БД

## Развертывание

### Docker Compose

Приложение развертывается через Docker Compose с тремя сервисами:

1. **postgres** - База данных PostgreSQL
2. **app** - PHP-FPM приложение
3. **nginx** - Веб-сервер

### Переменные окружения

- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASS` - Настройки БД
- `APP_URL` - URL приложения
- `APP_ENV` - Окружение (development/production)
- `APP_DEBUG` - Режим отладки

## Расширяемость

### Добавление нового функционала

1. Создать модель в `app/Models/`
2. Создать контроллер в `app/Controllers/`
3. Добавить маршруты в `config/routes.php`
4. Создать представления в `public/views/`

### Добавление нового API эндпоинта

1. Добавить метод в контроллер
2. Добавить маршрут в `config/routes.php`
3. Обработать JSON ответ через `$this->json()`

### Добавление middleware

1. Создать класс в `app/Middleware/`
2. Применить в конструкторе контроллера или через роутер

## Тестирование

### Логирование

- Все важные операции логируются
- Уровни логирования: DEBUG, INFO, WARNING, ERROR
- Логи доступны в `logs/app.log`

### Отладка

- Режим отладки включается через `APP_DEBUG=true`
- В режиме отладки показываются детальные ошибки
- Логируются все SQL запросы

## Будущие улучшения

### Возможные улучшения архитектуры

1. **Dependency Injection Container** - Для управления зависимостями
2. **Repository Pattern** - Для абстракции работы с БД
3. **Service Layer** - Для вынесения бизнес-логики из контроллеров
4. **Event System** - Для обработки событий (например, при создании вещи)
5. **Queue System** - Для асинхронных задач (обработка изображений)
6. **API Authentication** - Токены вместо сессий для API
7. **Caching Layer** - Redis для кеширования
8. **Unit Tests** - PHPUnit для тестирования
9. **API Versioning** - Версионирование API эндпоинтов

### Оптимизация

1. **Image Optimization** - Автоматическое сжатие и оптимизация изображений
2. **CDN** - Использование CDN для статических ресурсов
3. **Database Replication** - Репликация БД для чтения
4. **Load Balancing** - Балансировка нагрузки между серверами

## Заключение

Приложение построено на простой, но эффективной архитектуре MVC, которая обеспечивает:
- Четкое разделение ответственности
- Легкость поддержки и расширения
- Безопасность данных
- Производительность

Архитектура позволяет легко добавлять новый функционал и масштабировать приложение по мере роста пользовательской базы.

